<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sential AI | Smart Contract Security</title>
    
    <!-- Fonts: Orbitron & Open Sans & JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Open+Sans:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: '#0A100D',
                        surface: '#161b19',
                        primary: '#6C63FF',
                        secondary: '#00D4FF',
                        textMain: '#F1FAEE',
                        textMuted: '#69747C',
                    },
                    backgroundImage: {
                        'gradient-main': 'linear-gradient(90deg, #6C63FF 0%, #00D4FF 100%)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0A100D; color: #F1FAEE; overflow-x: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0A100D; }
        ::-webkit-scrollbar-thumb { background: #69747C; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6C63FF; }

        /* Accordion Styles */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        
        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .glow-text { text-shadow: 0 0 20px rgba(108, 99, 255, 0.6); }

        /* Video Background */
        #bg-video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 85vh;
            object-fit: cover; z-index: -1; opacity: 0.5;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            pointer-events: none;
        }

        /* Score Circle */
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--score-color) var(--score-percent), #2D3748 0);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .score-circle::before {
            content: ""; width: 100px; height: 100px;
            background: #161b19; border-radius: 50%; position: absolute;
        }
        .score-value {
            position: relative; z-index: 10;
            font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 1.5rem;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col relative">

    <!-- Background Video -->
    <video autoplay muted loop playsinline id="bg-video">
        <source src="video-bg.mp4" type="video/mp4">
    </video>

    <!-- Navbar -->
    <nav class="w-full border-b border-white/10 bg-bg/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="logo.png" alt="Sential" class="h-10 w-auto object-contain" onerror="this.style.display='none'"> 
                <div class="flex flex-col">
                    <span class="font-display font-bold text-2xl tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">SENTIAL</span>
                </div>
            </div>
            <div class="flex items-center gap-8 text-sm font-display uppercase tracking-wider hidden md:flex">
                <a href="#" class="text-textMuted hover:text-white transition-colors">Documentation</a>
                <a href="https://github.com/yourusername" target="_blank" class="flex items-center gap-2 border border-white/20 px-4 py-2 rounded-full hover:border-primary hover:bg-white/5 transition-all">View GitHub</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-6xl mx-auto px-6 py-16 relative z-10">
        
        <div class="text-center mb-16">
            <h1 class="font-display font-bold text-4xl md:text-6xl mb-6 uppercase leading-tight">
                Secure Your Smart Contracts with <br>
                <span class="text-transparent bg-clip-text bg-gradient-main glow-text">"SENTIAL AI"</span>
            </h1>
            <p class="text-textMuted text-lg max-w-2xl mx-auto font-light">
                The essential pre-flight check for Web3 developers. Paste your Solidity code below for an instant AI-powered security audit.
            </p>
        </div>

        <!-- Code Input -->
        <div class="relative group">
            <div class="absolute -inset-0.5 bg-gradient-main rounded-xl opacity-50 blur group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
            <div class="relative bg-surface rounded-xl border border-white/10 p-2 shadow-2xl">
                <div class="flex justify-between items-center px-4 py-2 border-b border-white/5 bg-black/20 rounded-t-lg">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    </div>
                    <span class="text-xs font-mono text-textMuted uppercase">INPUT CODE</span>
                    <label class="cursor-pointer text-xs text-secondary hover:text-white transition-colors font-mono flex items-center gap-2">
                        Upload .sol File
                        <input type="file" id="fileInput" accept=".sol" class="hidden">
                    </label>
                </div>
                <textarea id="codeInput" class="w-full h-[400px] bg-[#0d1117] text-gray-300 font-mono text-sm p-6 focus:outline-none resize-none placeholder-gray-700 leading-relaxed rounded-b-lg" placeholder="// Paste your Solidity smart contract code here..."></textarea>
            </div>
        </div>

        <!-- Audit Button -->
        <div class="flex justify-center mt-10">
            <button onclick="analyzeContract()" id="auditBtn" class="group relative px-10 py-4 bg-gradient-main text-white font-bold text-lg rounded-lg font-display tracking-wider transition-all shadow-[0_0_20px_rgba(108,99,255,0.5)] hover:shadow-[0_0_30px_rgba(0,212,255,0.6)] hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center gap-2"><span id="btnText">RUN SENTIAL AUDIT</span></span>
                <div id="loader" class="hidden absolute inset-0 flex items-center justify-center bg-gradient-main rounded-lg">
                    <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </button>
        </div>

        <!-- Results (Hidden) -->
        <div id="resultsSection" class="hidden mt-24 animate-fade-in pb-20">
            <div class="flex items-center gap-4 mb-10">
                <div class="w-2 h-8 bg-gradient-main rounded-sm"></div>
                <h2 class="font-display font-bold text-3xl uppercase">OVERALL ASSESSMENT</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="bg-surface border border-white/5 rounded-xl p-8 flex flex-col items-center justify-center shadow-lg">
                    <div class="score-circle mb-4" id="scoreCircle" style="--score-color: #6C63FF; --score-percent: 0%;">
                        <span class="score-value" id="scoreText">0/10</span>
                    </div>
                    <h3 class="font-display text-primary text-xl font-bold">Security Score</h3>
                </div>
                <div class="md:col-span-2 bg-surface border border-white/5 rounded-xl p-8 shadow-lg">
                    <div class="prose prose-invert max-w-none">
                        <p id="summaryText" class="text-gray-300 leading-relaxed">AI analysis pending.</p>
                    </div>
                </div>
            </div>

            <div class="space-y-6" id="accordionContainer"></div>
        </div>
    </main>

    <footer class="border-t border-white/5 mt-auto py-10 text-center bg-bg/80 backdrop-blur-sm">
        <div class="flex items-center justify-center gap-2 mb-4 opacity-50">
            <div class="w-6 h-6 bg-gradient-to-br from-primary to-secondary rounded flex items-center justify-center text-black font-bold font-display text-xs">S</div>
            <span class="font-display font-bold text-lg tracking-widest">BLOCKVIA</span>
        </div>
        <p class="text-textMuted text-sm">Â© 2025 BlockVIA. Powered by Sential AI.</p>
    </footer>

    <script>
        // --- SMART PARSING LOGIC (FIXED) ---
        const API_URL = "/api/analyze"; 

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('codeInput').value = e.target.result; };
            reader.readAsText(file);
        });

        // 1. Robust Section Extractor
        // This splits the document by headers (##) and looks for keywords loosely
        function extractFuzzySection(markdown, keywords) {
            const sections = markdown.split(/##\s+/); // Split by Markdown headers
            // Find the section that contains ANY of the keywords (case insensitive)
            const found = sections.find(s => keywords.some(k => s.toUpperCase().includes(k.toUpperCase())));
            
            // Remove the title line from the section content for cleaner display
            if (found) {
                const lines = found.split('\n');
                lines.shift(); // Remove the first line (which is the title)
                return lines.join('\n').trim();
            }
            
            return "No specific details returned for this section.";
        }

        // 2. Robust Score Extractor
        // Looks for patterns like "8/10", "Score: 7", "10/10" anywhere in the text
        function extractScore(markdown) {
            const regex = /(\d{1,2}(\.\d+)?)\s*\/\s*10/; 
            const match = markdown.match(regex);
            return match ? parseFloat(match[1]) : 0;
        }

        function createAccordionItem(title, content, type) {
            const styles = {
                critical: { color: 'text-red-400', border: 'hover:border-red-500/30', icon: 'ðŸ”´' },
                high: { color: 'text-orange-400', border: 'hover:border-orange-500/30', icon: 'ðŸŸ ' },
                medium: { color: 'text-yellow-400', border: 'hover:border-yellow-500/30', icon: 'ðŸŸ¡' },
                gas: { color: 'text-green-400', border: 'hover:border-green-500/30', icon: 'ðŸ’°' },
                best: { color: 'text-blue-400', border: 'hover:border-blue-500/30', icon: 'âœ…' }
            };
            const s = styles[type];

            return `
                <details class="group bg-surface border border-white/5 rounded-lg overflow-hidden transition-all ${s.border} open:border-white/20 open:shadow-lg">
                    <summary class="flex items-center justify-between p-6 cursor-pointer select-none bg-white/2 group-hover:bg-white/5 transition-colors">
                        <div class="flex items-center gap-4">
                            <span class="text-2xl">${s.icon}</span>
                            <h3 class="font-display font-bold text-lg tracking-wide uppercase ${s.color} glow-text">${title}</h3>
                        </div>
                        <svg class="w-6 h-6 text-gray-500 transform group-open:rotate-180 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </summary>
                    <div class="p-6 pt-0 border-t border-white/5 bg-black/20">
                        <div class="prose prose-invert max-w-none mt-4 font-light text-gray-300">
                            ${marked.parse(content)}
                        </div>
                    </div>
                </details>
            `;
        }

        async function analyzeContract() {
            const code = document.getElementById('codeInput').value;
            const btn = document.getElementById('auditBtn');
            const loader = document.getElementById('loader');
            const results = document.getElementById('resultsSection');
            const container = document.getElementById('accordionContainer');

            if (!code.trim()) { alert("Please enter Solidity code."); return; }

            btn.disabled = true;
            document.getElementById('btnText').classList.add('opacity-0');
            loader.classList.remove('hidden');
            results.classList.add('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contractCode: code })
                });
                const data = await response.json();

                if (data.success) {
                    const md = data.analysis;

                    // FUZZY EXTRACTION (Case Insensitive & Flexible)
                    const critical = extractFuzzySection(md, ["CRITICAL", "VULNERABILITIES"]);
                    const high = extractFuzzySection(md, ["HIGH SEVERITY", "HIGH RISK"]);
                    const medium = extractFuzzySection(md, ["MEDIUM", "LOW", "WARNING"]);
                    const gas = extractFuzzySection(md, ["GAS", "OPTIMIZATION"]);
                    const best = extractFuzzySection(md, ["BEST PRACTICES", "SECURITY BEST"]);
                    const summary = extractFuzzySection(md, ["OVERALL", "ASSESSMENT", "CONCLUSION"]);

                    // Score Logic
                    const score = extractScore(md);
                    const circle = document.getElementById('scoreCircle');
                    
                    circle.style.setProperty('--score-percent', `${(score / 10) * 100}%`);
                    let color = score > 8 ? '#10B981' : (score > 5 ? '#FFD700' : '#FF4B4B');
                    circle.style.setProperty('--score-color', color);
                    document.getElementById('scoreText').innerText = `${score}/10`;

                    // Summary Injection
                    document.getElementById('summaryText').innerHTML = marked.parse(summary);
                    
                    // Accordion Injection
                    container.innerHTML = 
                        createAccordionItem("CRITICAL VULNERABILITIES", critical, 'critical') +
                        createAccordionItem("HIGH SEVERITY ISSUES", high, 'high') +
                        createAccordionItem("MEDIUM/LOW ISSUES", medium, 'medium') +
                        createAccordionItem("GAS OPTIMIZATIONS", gas, 'gas') +
                        createAccordionItem("BEST PRACTICES", best, 'best');

                    results.classList.remove('hidden');
                    setTimeout(() => results.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                } else {
                    alert("Audit Failed: " + data.error);
                }
            } catch (error) {
                console.error(error);
                alert("Connection Error. Ensure Backend is running.");
            } finally {
                btn.disabled = false;
                document.getElementById('btnText').classList.remove('opacity-0');
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
